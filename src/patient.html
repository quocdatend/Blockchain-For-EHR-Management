<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Patient</title>
    <link rel="icon" type="image/x-icon" href="assets/img/cardiogram.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet"
        type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles1.css" rel="stylesheet" />
    <script>
        function toggleImage(imgId) {
            var img = document.getElementById(imgId);
            if (img.style.display === "none") {
                img.style.display = "block";
            } else {
                img.style.display = "none";
            }
        }
    </script>
    <style>
        .container4 {
            max-width: 600px;
            margin: 50px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        label {
            font-size: 16px;
            color: #555;
        }

        input[type="date"],
        input[type="text"],
        input[type="submit"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        input[type="submit"] {
            background-color: #28a745;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        input[type="submit"]:hover {
            background-color: #218838;
        }

        #confirmation {
            margin-top: 20px;
            text-align: center;
            font-size: 16px;
            color: #0069d9;
            display: none;
        }

        /* Phần tử chứa hồ sơ y tế */
        #records {
            display: none;
            /* Ẩn mặc định */
            padding: 20px;
            margin-top: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            color: #333;
        }

        /* Phần tử chứa mỗi record */
        .record {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .record:hover {
            transform: scale(1.02);
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Tiêu đề record */
        .record-title {
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }

        /* Nội dung record */
        .record-content {
            font-size: 16px;
            color: #555;
            line-height: 1.6;
        }

        /* Thông tin phụ */
        .record-footer {
            font-size: 14px;
            color: #888;
            margin-top: 10px;
            text-align: right;
        }

        /* Nút hiển thị/ẩn hồ sơ y tế */
        .btn-info {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            padding: 12px 24px;
            font-size: 18px;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.3s ease;
            cursor: pointer;
        }

        .btn-info:hover {
            background-color: #0056b3;
            border-color: #004085;
            transform: translateY(-2px);
        }

        .btn-info:active {
            background-color: #004085;
            border-color: #003366;
            transform: translateY(0);
        }

        /* Các hiệu ứng động cho nút khi trạng thái "Ẩn Hồ Sơ Y Tế" */
        .hide-records {
            background-color: #28a745;
        }

        .hide-records:hover {
            background-color: #218838;
        }

        /* Các hiệu ứng động cho nút khi trạng thái "Xem Hồ Sơ Y Tế" */
        .view-records {
            background-color: #dc3545;
        }

        .view-records:hover {
            background-color: #c82333;
        }
        .form-row {
            display: flex; /* Hiển thị nội dung trên cùng một dòng */
            gap: 10px; /* Khoảng cách giữa các mục */
            align-items: center; /* Căn chỉnh giữa các mục (tùy chọn) */
            white-space: nowrap; /* Ngăn chặn xuống dòng */
        }
        .comments {
    display: block;
    white-space: normal;
    width: 500px; /* Độ rộng mong muốn */
}
        
    </style>
</head>

<body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">

            <span class="d-none d-lg-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2"
                    src="assets/img/profile.jpg" alt="..." /></span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
            aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span
                class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#about">About</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#experience">Your Data</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#education">appointment</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#access">Wait Access</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#accessDoctor">Access Doctor</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#skills">Access Holders</a></li>
                <!-- <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#BookAppointment">BookAppointment</a> -->
                <!-- </li> -->
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#orderMedicine">Order Medicine</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#statusorder">Status Order</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="./index.html">Logout</a></li>
            </ul>
        </div>
    </nav>
    <!-- Page Content-->
    <div class="container-fluid p-0">
        <!-- About-->
        <section class="resume-section" id="about">

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="text-white">
                        ......................................................................................................
                    </h3>
                    <h3 class="text-center">Personal Information</h3>

                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-offset-1 col-sm-10">
                            <table class="table">
                                <tr>
                                    <th>Name:</th>
                                    <td id="name"></td>
                                </tr>
                                <tr>
                                    <th>mobile:</th>
                                    <td id="age"></td>
                                </tr>
                            </table>
                        </div>

                    </div>

                </div>
        </section>
        <hr class="m-0" />
        <!-- Experience-->
        <section class="resume-section" id="experience">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="text-white">
                        ......................................................................................................
                    </h3>
                    <h3 class="text-center">Personal Information</h3>
                </div>
                <div class="panel-body">
                    <div class="row">

                        <h5>Your records are stored here: </h5>
                        <button type="submit" class="btn btn-info btn-lg" onclick="showRecords(this)">View medical
                            records</button>

                        <pre id="records" style="margin-top: 20px;">


                        </div>
                    </div>
                       
                </div>
            </div>
                
            </section>
            <hr class="m-0" />
            <!--Education -->
            <section class="resume-section" id="education">
                <div class="panel panel-default" width="10">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-sm-offset-1 col-sm-1000">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h3 class="text-white">......................................................................................................</h3>
                                        <h3 class="text-center">Create an Appointment</h3>
                                    </div>
                                    <div class="panel-body ">
                                        <div class="row">
                                            <div class="alert alert-info">
                                                <strong>Info!</strong> The healthcare already has access to your records. Revoke access or wait for time duration to end to continue.
                                            </div>
                                        </div>
                                        <form class="form-horizontal" action="/action_page.php">
                                            <div class="form-group "> 
                                                <label for="permithealthcareList" class="control-label">Hospital:</label>
                                                    <select class="form-control" id="permithealthcareList">
                                                        <option selected disabled>-- Please Select--</option>
                                                    </select>
                                            </div>
                                        </form>
                                        <div id="showSpeciaty">

                                        </div>
                                        <!-- <div class="text-center">
                                            <button id="submitButton" onclick="createAnAppointment()" class="btn btn-primary btn-lg" style="display: none; margin-left: 40%;margin-top: 10px;">Submit</button>
                                        </div>                                         -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </section>
            <hr class="m-0" />
            <section class="resume-section" id="access">

                <div class="panel panel-default " >
                <div class="panel-heading">
                    <h3 class="text-white">.............................................................................................................................</h3>
                    <h3 class="text-center col-sm-offset-1 col-sm-10">Current wait access</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="alert alert-danger">
                            <strong>Notice!</strong> The access could not be revoked. Please retry or contact admin.
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-offset-1 col-sm-10">
                            <table id="accessDoc1" class="table table-hover">
                                <tr>
                                    <th>healthcare</th>
                                    <th class="publicKeyhealthcare1">Public Key</th>
                                    <th>Access</th>
                                    <th>Cancel access</th>
                                </tr>
                            </table>
                        </div>
                    </div>

                </div>
            </div>    
            </section>
            <hr class="m-0" />
            <!--access Doctor -->
            <section class="resume-section" id="accessDoctor">
                                <div class="panel panel-default" width="10">
                                    <div class="panel-body">
                        <div class="row">
                            <div class="col-sm-offset-1 col-sm-1000">
                                            <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="text-white">......................................................................................................</h3>
                        <h3 class="text-center">Send Records to Doctor</h3>
                    </div>
                    <div class="panel-body ">
                        <div class="row">
                            <div class="alert alert-info">
                                <strong>Info!</strong> The healthcare already has access to your records. Revoke access or wait for time duration to end to continue.
                            </div>
                        </div>

                        
                        <form class="form-horizontal" action="/action_page.php">
                            <div class="form-group "> 
                                <label for="showListDoctor" class="control-label">Healthcare:</label>
                                    <select class="form-control" id="showListDoctor">
                                        <option selected disabled>-- Please Select--</option>
                                    </select>
                            </div>
                        </form>
                        <div class="text-center">
                            <button onclick = "sendRequestAccessDoctor()" class="btn btn-primary btn-lg">Submit</button>
                        </div>
                    </div>
                </div>
                            
                            </div>
                        </div>
                        
                    </div>
                </div>
                    
            </section>
            <hr class="m-0" />
            <section class="resume-section" id="skills">

                <div class="panel panel-default " >
                <div class="panel-heading">
                    <h3 class="text-white">.............................................................................................................................</h3>
                    <h3 class="text-center col-sm-offset-1 col-sm-10">Current EMR access holders</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="alert alert-danger">
                            <strong>Notice!</strong> The access could not be revoked. Please retry or contact admin.
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-offset-1 col-sm-10">
                            <table id="accessDoc" class="table table-hover">
                                <tr>
                                    <th>healthcare</th>
                                    <th class="publicKeyhealthcare">Public Key</th>
                                    <th>Revoke access</th>
                                </tr>
                            </table>
                        </div>
                    </div>

                </div>
            </div>    
            </section>
            <hr class="m-0" />
            
            <!--access Doctor -->
            <section class="resume-section" id="orderMedicine">
                            <div class="panel panel-default" width="10">
                                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-offset-1 col-sm-1000">
                                        <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="text-white">......................................................................................................</h3>
                    <h3 class="text-center">Send request to Hospital</h3>
                </div>
                <div class="panel-body ">
                    <div class="row">
                        <div class="alert alert-info">
                            <strong>Info!</strong> The healthcare already has access to your records. Revoke access or wait for time duration to end to continue.
                        </div>
                    </div>

                    
                    <form class="form-horizontal" action="/action_page.php">
                        <div class="form-group "> 
                            <label for="showListHospital" class="control-label">Hospital:</label>
                                <select class="form-control" id="showListHospital">
                                    <option selected disabled>-- Please Select--</option>
                                </select>
                        </div>
                    </form>
                    <div class="text-center">
                        <button onclick = "sendRequestOrderMedicine()" class="btn btn-primary btn-lg">Submit</button>
                    </div>
                </div>
            </div>
                        
                        </div>
                    </div>
                    
                </div>
            </div>
            
        </section>
        <hr class="m-0" />
        <section class="resume-section" id="statusorder">

            <div class="panel panel-default " >
            <div class="panel-heading">
                <h3 class="text-white">.............................................................................................................................</h3>
                <h3 class="text-center col-sm-offset-1 col-sm-10">Show Status Order Medicines</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="alert alert-danger">
                        <strong>Notice!</strong> The access could not be revoked. Please retry or contact admin.
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-offset-1 col-sm-10">
                        <table id="status-order" class="table table-hover">
                            <tr>
                                <th>Hospital</th>
                                <th class="publicKeyhealthcare">Public Key</th>
                                <th>Status</th>
                            </tr>
                        </table>
                    </div>
                </div>

            </div>
        </div>    
        </section>
        </div>
      <script src="js/jquery.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="js/bootstrap.min.js"></script>
<script src="js/web3.min.js"></script>
<script src="js/app.js"></script>

<script>

    var url_string = window.location.href;
    var url = new URL(url_string);
    var key;

    toggleRecordsButton = 0;
    var recordHash = "";
    const departments = {
        ngoaiKhoa: [
            "Ngoại tim mạch",
            "Ngoại lồng ngực",
            "Ngoại tiêu hóa",
            "Phẫu thuật mắt",
            "Ngoại tổng quát",
            "Ngoại thần kinh",
            "Phẫu thuật miệng & hàm mặt",
            "Ngoại chỉnh hình",
            "Phẫu thuật bàn tay",
            "Tai mũi họng",
            "Ngoại nhi",
            "Phẫu thuật tạo hình",
            "Phẫu thuật sinh dục",
            "Ung bướu ngoại khoa",
            "Ghép tạng",
            "Ngoại chấn thương",
            "Ngoại tiết niệu Nam khoa",
            "Phẫu thuật mạch máu",
        ],
        noiKhoa: [
            "Dị ứng / Miễn dịch học",
            "Nội tim mạch",
            "Nội tiết",
            "Khoa tiêu hóa",
            "Lão",
            "Huyết học",
            "Bệnh truyền nhiễm",
            "Nội thận",
            "Nội ung bướu",
            "Khoa hô hấp",
            "Phong thấp",
        ],
        sanPhuKhoa: [
            "Phụ khoa",
            "Ung bướu phụ khoa",
            "Thai nhi",
            "Sản khoa",
            "Sinh lý nội tiết sinh sản và vô sinh",
            "Sinh dục",
        ],
        chanDoan: [
            "Khoa X quang",
            "Khoa xạ trị",
        ],
        cacKhoaKhac: [
            "Addiction medicine",
            "Adolescent medicine",
            "Gây mê",
            "Dermatology",
            "Disaster medicine",
            "Diving medicine",
            "Y học cấp cứu",
            "Y học gia đình",
            "Bác sĩ đa khoa",
            "Hospital medicine",
            "Y học chăm sóc tích cực",
            "Di truyền học y khoa",
            "Thần kinh học",
            "Occupational medicine",
            "Nhãn khoa",
            "Điều trị đau",
            "Palliative care",
            "Nhi khoa",
            "Vật lý trị liệu và phục hồi chức năng",
            "Y học dự phòng",
            "Tâm thần khoa",
            "Ung bướu phóng xạ",
            "Y học sinh sản",
            "Sexual medicine",
            "Y học giấc ngủ",
            "Y học thể thao",
            "Y học cấy ghép",
            "Y học nhiệt đới",
        ]
    };
    $(window).load(function () {
        connect();
        $("#records").hide();
        $(".alert-info").hide();
        $(".alert-danger").hide();
        key = web3.currentProvider.selectedAddress;
        key = key.toLocaleLowerCase();

        var a = "";
        var b = 0;
        var ailments = [];

        contractInstance.get_wait_handle_request_order_medicine(key, { gas: 1000000 }, function (error, result) {
            if (!error) {
                hospitalAddressList = result;
                console.log(result);
                hospitalAddressList.forEach(function (hospitalAddress, index) {
                    contractInstance.get_hospital.call(hospitalAddress, { gas: 1000000 }, function (error, result) {
                        var table = document.getElementById("status-order");
                        if (!error) {
                            [a, b] = result;
                            console.log(a);

                            var row = table.insertRow(index + 1);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            cell2.className = "publicKeyhospital";
                            cell1.innerHTML = a;
                            cell2.innerHTML = hospitalAddress;
                            cell3.innerHTML = `<input class="btn btn-info" type="button" value="Waitting..."></input>`;
                        }
                        else
                            console.error(error);
                    })
                })
            } else console.log(error);
        })
        contractInstance.get_wait_payment_request_order_medicine(key, { gas: 1000000 }, function (error, result) {
            if (!error) {
                hospitalAddressList = result;
                console.log(result);
                hospitalAddressList.forEach(function (hospitalAddress, index) {
                    contractInstance.get_hospital.call(hospitalAddress, { gas: 1000000 }, function (error, result) {
                        var table = document.getElementById("status-order");
                        if (!error) {
                            [a, b] = result;
                            console.log(a);
                            var row = table.insertRow(index + 1);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            cell2.className = "publicKeyhospital";
                            cell1.innerHTML = a;
                            cell2.innerHTML = hospitalAddress;
                            cell3.innerHTML =  `<input class="btn btn-primary" onclick="paymentOrderMedicine(this)" style="color:white;" type="button" value="Access Payment"></input>
                            <input class="btn btn-danger" onclick="cancelPaymentOrderMedicine(this)" style="margin-top:10px"; type="button" value="Cancel Payment"></input>`;
                        }
                        else
                            console.error(error);
                    })
                })
            } else console.log(error);
        })
        contractInstance.get_was_deleted_request_order_medicine(key, { gas: 1000000 }, function (error, result) {
            if (!error) {
                hospitalAddressList = result;
                console.log(result);

                hospitalAddressList.forEach(function (hospitalAddress, index) {
                    contractInstance.get_hospital.call(hospitalAddress, { gas: 1000000 }, function (error, result) {
                        var table = document.getElementById("status-order");
                        if (!error) {
                            [a, b] = result;
                            console.log(a);

                            var row = table.insertRow(index + 1);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            cell2.className = "publicKeyhospital";
                            cell1.innerHTML = a;
                            cell2.innerHTML = hospitalAddress;
                            cell3.innerHTML = `<input class="btn btn-danger" onclick="accessStatusDeleted(this)" type="button" value="Was Cancelled"></input>`;
                        }
                        else
                            console.error(error);
                    })
                })
            } else console.log(error);
        })
        contractInstance.get_success_request_order_medicine(key, { gas: 1000000 }, function (error, result) {
            if (!error) {
                hospitalAddressList = result;
                console.log(result);

                hospitalAddressList.forEach(function (hospitalAddress, index) {
                    contractInstance.get_hospital.call(hospitalAddress, { gas: 1000000 }, function (error, result) {
                        var table = document.getElementById("status-order");
                        if (!error) {
                            [a, b] = result;
                            console.log(a);

                            var row = table.insertRow(index + 1);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            cell2.className = "publicKeyhospital";
                            cell1.innerHTML = a;
                            cell2.innerHTML = hospitalAddress;
                            cell3.innerHTML = `<input class="btn btn-success" onclick="accessStatusSuccess(this)" type="button" value="Payment Success"></input>`;
                        }
                        else
                            console.error(error);
                    })
                })
            } else console.log(error);
        })
        // print patient details 
        console.log("Getting Patient Data");
        contractInstance.get_patient(key, { gas: 1000000 }, function (error, result) {
            console.log("Patient Data Result:" + result);
            if (!error) {
                a = result[0];
                b = result[1];
                ailments = result[2];

                recordHash = result[4];
                $("#name").html(a);
                $("#age").html(b.c[0]);
                $("#recordsHash").html(recordHash);

            }
            else
                console.error(error);
        });

        // print out the healthcares to share emr
        var healthcareList = 0;
        console.log("Getting healthcare List");
        contractInstance.get_healthcare_list({ gas: 1000000 }, function (error, result) {

            if (!error) {

                healthcareList = result;

                for (var i = 0; i < healthcareList.length; i++) {
                    contractInstance.get_healthcare.call(healthcareList[i], { gas: 1000000 }, function (error, result) {

                        // var list = document.getElementById("permithealthcareList");
                        var list1 = document.getElementById("showListDoctor");
                        if (!error) {
                            [a, b] = result;
                            // var option = document.createElement("option");
                            // option.text = a + " :" + b;
                            // list.add(option);
                            var option1 = document.createElement("option");
                            option1.text = a + " :" + b;
                            list1.add(option1);
                            // console.log(a);
                        }
                        else
                            console.error(error);
                    })
                }
            }
            else
                console.error(error);
        });
        var healthcareAddressList = 0;
        contractInstance.get_accessed_healthcarelist_for_patient.call(key, { gas: 1000000 }, function (error, result) {
            if (!error) {
                healthcareAddressList = result;
                console.log("RevokeAccessList: ", healthcareAddressList);
                healthcareAddressList.forEach(function (healthcareAddress, index) {
                    contractInstance.get_healthcare.call(healthcareAddress, { gas: 1000000 }, function (error, result) {
                        var table = document.getElementById("accessDoc");
                        if (!error) {
                            [a, b] = result;
                            console.log(a);
                            var row = table.insertRow(index + 1);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            cell2.className = "publicKeyhealthcare";
                            cell1.innerHTML = a;
                            cell2.innerHTML = healthcareAddress;
                            cell3.innerHTML = '<button onclick="revokeAccess(this)" class="btn btn-danger">RevokeAccess</button>';

                            console.log(result);
                        }
                        else
                            console.error(error);
                    })
                })
            }
            else
                console.error(error);
        });

        // print out the healthcares who have access
        var healthcareAddressList = 0;
        contractInstance.get_request_healthcarelist_for_patient.call(key, { gas: 1000000 }, function (error, result) {
            if (!error) {
                healthcareAddressList = result;
                console.log("WaitAccessList: ", healthcareAddressList);
                healthcareAddressList.forEach(function (healthcareAddress, index) {
                    contractInstance.get_healthcare.call(healthcareAddress, { gas: 1000000 }, function (error, result) {
                        var table = document.getElementById("accessDoc1");
                        if (!error) {
                            [a, b] = result;
                            console.log(a);
                            var row = table.insertRow(index + 1);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            var cell4 = row.insertCell(3);
                            cell2.className = "publicKeyhealthcare1";
                            cell1.innerHTML = a;
                            cell2.innerHTML = healthcareAddress;
                            cell3.innerHTML = '<button onclick="submitAccess(this)" class="btn btn-warning">Access</button>';
                            cell4.innerHTML = '<button onclick="CancekAccess(this)" class="btn btn-danger">CancekAccess</button>';
                            console.log(result);
                        }
                        else
                            console.error(error);
                    })
                })
            }
            else
                console.error(error);
        });
        contractInstance.get_hospital_list.call({
            gas: 1000000
        }, function (error, result) {
            if (!error) {
                hospitalAddrList = result;
                for (var i = 0; i < hospitalAddrList.length; i++) {
                    contractInstance.get_hospital.call(hospitalAddrList[i], {
                        gas: 1000000
                    }, function (error, result) {
                        var list = document.getElementById("showListHospital");
                        if (!error) {
                            [a, b, c, d, e] = result;
                            var option = document.createElement("option");
                            option.text = a + " :" + b;
                            list.add(option);
                        } else console.log(error);
                    });
                }
            } else console.log(error);
        });
        contractInstance.get_hospital_list.call({
            gas: 1000000
        }, function (error, result) {
            if (!error) {
                hospitalAddrList = result;
                for (var i = 0; i < hospitalAddrList.length; i++) {
                    contractInstance.get_hospital.call(hospitalAddrList[i], {
                        gas: 1000000
                    }, function (error, result) {
                        var list = document.getElementById("permithealthcareList");
                        if (!error) {
                            [a, b, c, d, e] = result;
                            var option = document.createElement("option");
                            option.text = a + " :" + b;
                            list.add(option);
                        } else console.log(error);
                    });
                }
            } else console.log(error);
        });
        
        document.getElementById("permithealthcareList").addEventListener("change", function (event) {
            const selectedValue = event.target.value;
            // add html to showSpeciaty
            var showSpeciaty = document.getElementById("showSpeciaty");
            showSpeciaty.innerHTML = `
            <div class="container" style="border:1px solid #333;border-radius:10px;margin-top:20px;">
                                <h4>Chọn Chuyên Khoa</h4>
                                <label for="specialty">Chuyên Khoa:</label>
                                <select id="specialty" onchange="showDepartments()">
                                    <option value="" selected disabled>-- Chọn chuyên khoa --</option>
                                    <option value="ngoaiKhoa">Ngoại khoa</option>
                                    <option value="noiKhoa">Nội khoa</option>
                                    <option value="sanPhuKhoa">Sản phụ khoa</option>
                                    <option value="chanDoan">Chẩn đoán</option>
                                    <option value="cacKhoaKhac">Các khoa khác</option>
                                </select>
                                <h6>Tên Chuyên Khoa:</h6>
                                <p id="specialtyName">Vui lòng chọn một chuyên khoa.</p>
                                <h6>Danh Sách Khoa:</h6>
                                <ul id="departmentList" style="list-style-type: none; padding: 0;">
                                    <li>Vui lòng chọn một chuyên khoa để xem danh sách các khoa.</li>
                                </ul>
                                <select id="specialtydepartmentList">
                                    <option value="" selected disabled>-- Chọn khoa --</option>
                                </select>
                                <div class="selected-info" style="margin-top: 20px; font-size: 18px; color: #555;">
                                    <strong>Khoa đã chọn:</strong> <span id="selectedDepartment">Chưa chọn</span>
                                </div>
                                <h6>Chọn Lịch:</h6>
                                <div style="margin-top: 10px;">
                                    <label for="appointmentDate">Ngày:</label>
                                    <input type="date" id="appointmentDate" style="margin-left: 10px;">
                                </div>
                                <div style="margin-top: 20px;">
                                  <button id="confirmButton" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Chọn</button>
                                </div>
                                <div class="col-sm-offset-1 col-sm-10">
                            <table id="getDoctor" class="table table-hover">
                                <tr>
                                    <th>healthcare</th>
                                    <th class="publicKeyDoctor">Public Key</th>  
                                    <th>chosen</th>                                 
                                </tr>
                            </table>
                        </div>
                        <div id="noDoctorMessage" style="margin-top: 20px; color: red; font-weight: bold; display: none;">
                            Không có bác sĩ nào trong ngày được chọn. Vui lòng chọn ngày khác.
                        </div>
                            </div>`;
 

                            
        document.getElementById("confirmButton").addEventListener("click", function () {
                const specialtyElement = document.getElementById("specialty");
                const selectedSpecialty = specialtyElement.options[specialtyElement.selectedIndex]?.text || "Chưa chọn";
                const departmentElement = document.getElementById("specialtydepartmentList");
                const selectedDepartment = departmentElement.options[departmentElement.selectedIndex]?.text || "Chưa chọn";
                const appointmentDate = document.getElementById("appointmentDate").value || "Chưa chọn ngày";
                // Log dữ liệu ra console
                console.log("Thông tin đã chọn:");
                console.log("Chuyên khoa:", selectedSpecialty);
                console.log("Khoa:", selectedDepartment);
                console.log("Ngày hẹn:", appointmentDate);
                let healthcareAddressList = []; // Mảng chứa địa chỉ từ department
                let healthcareAddressList1 = []; // Mảng chứa địa chỉ từ appointmentDate
                const table = document.getElementById("getDoctor");
                while (table.rows.length > 1) { // Retain the header row
                    table.deleteRow(1);
                }

                var list = document.getElementById("permithealthcareList");
                index = list.selectedIndex;
                var healthcareList3 = 0;
                contractInstance.get_healthcare_list({ gas: 1000000 }, function (error, result) {
                    console.log(index);
                    healthcareList3 = result;
                    console.log("healthcareList3",healthcareList3)
                })
                // Lấy danh sách địa chỉ từ department
                contractInstance.getAddressesByField.call(selectedDepartment, true, { gas: 1000000 }, function (error, result) {
                    if (!error) {
                        healthcareAddressList = result;
                        console.log("WaitAccessList: ", healthcareAddressList);
                        // Sau khi có kết quả từ department, gọi tiếp để lấy danh sách từ appointmentDate
                        contractInstance.getAddressesByField.call(appointmentDate, false, { gas: 1000000 }, function (error, result) {
                            if (!error) {
                                healthcareAddressList1 = result;
                                console.log("WaitAccessList1: ", healthcareAddressList1);

                                // Tìm các địa chỉ trùng lặp giữa hai danh sách
                                let combinedList = healthcareAddressList.filter(address => 
                                    healthcareAddressList1.includes(address) && healthcareList3.includes(address)
                                );
                                if (combinedList.length == 0) {
                                    document.getElementById("noDoctorMessage").style.display = "block";
                                } else {
                                    document.getElementById("noDoctorMessage").style.display = "none";
                                }
                                combinedList.forEach(function (healthcareAddress, index) {
                                    contractInstance.get_healthcare.call(healthcareAddress, { gas: 1000000 }, function (error, result) {
                                        var table = document.getElementById("getDoctor");
                                        if (!error) {
                                            [a, b] = result;
                                            console.log(a);
                                            var row = table.insertRow(index + 1);
                                            var cell1 = row.insertCell(0);
                                            var cell2 = row.insertCell(1);
                                            var cell3 = row.insertCell(2);
                                            var cell4 = row.insertCell(3);
                                            cell2.className = "publicKeyDoctor";
                                            cell1.innerHTML = a;
                                            cell2.innerHTML = healthcareAddress;
                                            cell3.innerHTML = '<button onclick="createAnAppointment(this)" class="btn btn-warning">Chosen</button>';
                                            console.log(result);
                                        }
                                        else
                                            console.error(error);
                                    })
                                })

                                console.log("Combined Healthcare Address List (Duplicates): ", combinedList);
                            } else {
                                console.error(error);
                            }
                        });
                    } else {
                        console.error(error);
                    }
                });
            });
        });

    });
    function showDepartments() {
        const specialtyDropdown = document.getElementById("specialty");
        const specialtyValue = specialtyDropdown.value;
        const specialtyText = specialtyDropdown.options[specialtyDropdown.selectedIndex].text;

        const departmentList = document.getElementById("specialtydepartmentList");
        const specialtyName = document.getElementById("specialtyName");

        // Cập nhật tên chuyên khoa
        specialtyName.textContent = specialtyText;

        // Xóa danh sách hiện tại
        departmentList.innerHTML = "";

        // Nếu chưa chọn chuyên khoa, hiển thị thông báo
        if (!specialtyValue || !departments[specialtyValue]) {
            departmentList.innerHTML = "<li>Vui lòng chọn một chuyên khoa để xem danh sách các khoa.</li>";
            return;
        }

        // Tạo danh sách các khoa
        departments[specialtyValue].forEach(department => {
            const li = document.createElement("option");
            li.textContent = department;
            li.style = `background-color: #f9f9f9;
        margin: 5px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;`;
            li.onclick = () => selectDepartment(department); // Gắn sự kiện khi click
            departmentList.appendChild(li);
        });
    }
    function submitchoicespecialty() {
        var getspecialty = document.getElementById("selectedDepartment");
        contractInstance.choice_specialty.sendTransaction(getspecialty.textContent, {
            from: key,
            gas: 1000000,
            value: web3.toWei(2, 'ether')
        }, function (error) {
            if (!error) {
                alert("Đã gửi yêu cầu");
                location.reload();
            } else console.log(error);
        })
    }

    // Hàm xử lý khi chọn một khoa
    function selectDepartment(department) {
        const selectedDepartment = document.getElementById("selectedDepartment");
        selectedDepartment.textContent = department; // Hiển thị tên khoa đã chọn
    }
    function accessStatusDeleted(element) {
        var table = document.getElementById("status-order");
        var index = element.parentNode.parentNode.rowIndex;
        var hospitalAddress = table.rows[index].cells[1].innerHTML;
        contractInstance.remove_status_order_request.sendTransaction(hospitalAddress, { from: key, gas: 1000000, value: web3.toWei(2, 'ether') }, function (error) {
            if (!error) {
                console.log("Access status deleted");
            } else console.log(error);
        })
    }
    function sendRequestOrderMedicine() {
        var hospital = document.getElementById("showListHospital");
        var index = hospital.selectedIndex;
        var hospitalList;
        contractInstance.get_hospital_list.call({
            gas: 1000000
        }, function (error, result) {
            if (!error) {
                hospitalList = result;
                contractInstance.request_ordor_medicine.sendTransaction(hospitalList[index - 1], { from: key, gas: 1000000, value: web3.toWei(2, 'ether') }, function (error) {
                    if (!error) {
                        console.log("Request Order Medicine Success");
                        alert("Send request to Hospital was completed.");
                        location.reload();
                    }
                    
                    else {
                        $(".alert-info").show();   
                        console.log(error); 
                    }
                });
            } else console.log(error);
        });
    }

    function showRecords(element) {
        if (toggleRecordsButton % 2 == 0) {
            $.get("http://localhost:8081/ipfs/" + recordHash, function (data) {
                var content = $('<div>').html(data);
                var recordSigns = content.find('.recordSign').get();
                var index = recordSigns.length;  
                $(recordSigns).each(function () {
                    $(this).before('<center> <p>This is a record ' + index + '</p> </center>');
                    index--;  // Giảm chỉ số
                });
                    $("#records").html(content);
                    $("#records").show();
                })
            // $.get("http://localhost:8081/ipfs/"+recordHash, function(data){
            //     $("#records").html(data);
            //     $("#records").show();
            // })
            toggleRecordsButton += 1
            element.innerHTML = "Hide Medical Records";
            element.className = "btn btn-info btn-lg";
        } else {
            $("#records").hide();
            toggleRecordsButton -= 1;
            element.innerHTML = "View Medical Records";
            element.className = "btn btn-info btn-lg"
        }
    }
    
    function sendRequestAccessDoctor() {
        var list = document.getElementById("showListDoctor");
        index = list.selectedIndex;
        var healthcareList = 0;
        contractInstance.get_healthcare_list({ gas: 1000000 }, function (error, result) {
            if (!error) {
                console.log(index);
                healthcareList = result;
                healthcareToBeAdded = healthcareList[index - 1];
                contractInstance.permit_access.sendTransaction(healthcareToBeAdded, { from: key, gas: 1000000, value: web3.toWei(2, 'ether') }, function (error) {
                    if (!error) {
                        console.log("Access granted to doctor");
                        alert("Send Records to Doctor was completed.");
                        location.reload();
                       } else {
                        $(".alert-info").show();
                        console.log(error);
                    }
                })
            } else
                console.log(error);
        })
    }

    function createAnAppointment(element) {
        rowNo = element.parentNode.parentNode.rowIndex;
        Row = element.parentNode.parentNode;
        var Cells = Row.getElementsByTagName("td");
        var docKey = Row.cells[1].firstChild.nodeValue;
        console.log("docKey :", docKey);
                contractInstance.create_an_appointment.sendTransaction(docKey, { from: key, gas: 1000000, value: web3.toWei(2, 'ether') }, function (error) {
                    if (!error) {
                        console.log("Appointment created");
                        alert("Create an Appointment was completed");
                        location.reload();
                       } else {
                        $(".alert-info").show();
                        console.log(error);
                    }
                })
        
    }
    // function giveAccess() {
    //     var list = document.getElementById("permithealthcareList");
    //     index = list.selectedIndex;
    //     var healthcareList = 0;
    //     contractInstance.get_healthcare_list({ gas: 1000000 }, function (error, result) {
    //         if (!error) {
    //             console.log(index);
    //             healthcareList = result;
    //             healthcareToBeAdded = healthcareList[index - 1];
    //             contractInstance.permit_access.sendTransaction(healthcareToBeAdded, { from: key, gas: 1000000, value: web3.toWei(2, 'ether') }, function (error) {
    //                 if (!error) {
    //                     var table = document.getElementById("accessDoc");
    //                     noRows = table.rows.length;
    //                     var row = table.insertRow(noRows);
    //                     var cell1 = row.insertCell(0);
    //                     var cell2 = row.insertCell(1);
    //                     var cell3 = row.insertCell(2);
    //                     cell2.className = "publicKeyhealthcare";
    //                     cell1.innerHTML = $("#permithealthcareList").val();
    //                     cell2.innerHTML = healthcareToBeAdded;
    //                     cell3.innerHTML = '<button onclick="revokeAccess(this)" class="btn btn-danger">Revoke access</button>';
    //                 } else {
    //                     $(".alert-info").show();
    //                     console.log(error);
    //                 }

    //             })

    //         } else
    //             console.log(error);
    //     })
    // }
    function submitAccess(element) {
        rowNo = element.parentNode.parentNode.rowIndex;
        Row = element.parentNode.parentNode;
        var Cells = Row.getElementsByTagName("td");
        var docKey = Row.cells[1].firstChild.nodeValue;
        console.log("docKey :", docKey);
        contractInstance.permit_access_and_remove_doctor_permit_access.sendTransaction(docKey, { from: key, gas: 1000000, value: web3.toWei(2, 'ether') }, function (error) {
            if (!error) {
                var table = document.getElementById("accessDoc");
                document.getElementById("accessDoc1").deleteRow(rowNo);
                noRows = table.rows.length;
                var row = table.insertRow(noRows);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                cell2.className = "publicKeyhealthcare";
                cell1.innerHTML = $("#permithealthcareList").val();
                cell2.innerHTML = docKey;
                cell3.innerHTML = '<button onclick="revokeAccess(this)" class="btn btn-danger">Revoke access</button>';
                location.reload();
            } else {
                $(".alert-info").show();
                console.log(error);
            }
        })
    }
    function CancekAccess(element) {
        rowNo = element.parentNode.parentNode.rowIndex;
        Row = element.parentNode.parentNode;
        var Cells = Row.getElementsByTagName("td");
        var docKey = Row.cells[1].firstChild.nodeValue;
        console.log("docKey :", docKey);
        contractInstance.cancel_access.sendTransaction(docKey, { from: key, gas: 1000000, value: web3.toWei(2, 'ether') }, function (error) {
            if (!error) {
                document.getElementById("accessDoc1").deleteRow(rowNo);
                
            } else {
                $(".alert-danger").show();
                console.log(error);
            }
        })
    }
    function revokeAccess(element) {
        rowNo = element.parentNode.parentNode.rowIndex;
        Row = element.parentNode.parentNode;
        var Cells = Row.getElementsByTagName("td");
        var docKey = Row.cells[1].firstChild.nodeValue;
        contractInstance.revoke_access(docKey, { gas: 1000000 }, function (error) {
            if (!error) {
                document.getElementById("accessDoc").deleteRow(rowNo);
                alert("revokeAccess was competed.");
                location.reload();
            } else {
                $(".alert-danger").show();
                console.log(error);
            }
        });
    }
    const form = document.getElementById('appointment-form');
    const confirmationDiv = document.getElementById('confirmation');
    const appointmentDetails = document.getElementById('appointment-details');
    form.addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent form submission to the server
        const date = document.getElementById('appointment-date').value;
        if (date) {
            console.log("aasdasd", date);
        }
    });

    function cancelPaymentOrderMedicine(element){
        var table = document.getElementById("status-order");

        var index = element.parentNode.parentNode.rowIndex;
        var patientAddress = table.rows[index].cells[1].innerHTML;
        contractInstance.cancel_payment_medicine.sendTransaction(patientAddress, {from: key, gas:1000000 , value: web3.toWei(2, 'ether')}, function(error) {
            if(!error) {
                alert("Cancel Payment!");
            } else console.log(error);
        });
    }
    function paymentOrderMedicine(element) {
        var table = document.getElementById("status-order");
        var index = element.parentNode.parentNode.rowIndex;
        var patientAddress = table.rows[index].cells[1].innerHTML;
        contractInstance.payment_medicine_success.sendTransaction(patientAddress, {from: key, gas:1000000 , value: web3.toWei(2, 'ether')}, function(error) {
            if(!error) {
                alert("Payment Success!");
            } else console.log(error);
        });
    }

</script>
    </body>
</html>